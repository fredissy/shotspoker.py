<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jira Poker Planning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .card-select { cursor: pointer; transition: 0.2s; }
        .card-select:hover { transform: scale(1.1); background-color: #0d6efd; color: white; }
        .voted-badge { background-color: #198754; color: white; }
        .waiting-badge { background-color: #ffc107; color: black; }
        #chartContainer { max-width: 400px; margin: 0 auto; }
        
        /* Login Screen Overlay Styles */
        #joinScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 249, 250, 0.98); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        
        .room-badge {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .room-badge:hover {
            background-color: #e2e6ea;
        }
    </style>
</head>
<body>

<div id="joinScreen">
    <div class="card shadow p-4" style="width: 450px;">
        <h3 class="text-center mb-3">Planning Poker</h3>
        
        <div class="mb-3">
            <label class="form-label">Your Name</label>
            <input type="text" id="joinName" class="form-control" placeholder="e.g. Alice">
        </div>

        <div class="mb-3">
             <label class="form-label">I am a...</label>
             <div class="btn-group w-100" role="group">
                 <input type="radio" class="btn-check" name="role" id="roleVoter" value="voter" checked>
                 <label class="btn btn-outline-primary" for="roleVoter">Voter</label>
                 <input type="radio" class="btn-check" name="role" id="roleObserver" value="observer">
                 <label class="btn btn-outline-secondary" for="roleObserver">Observer ðŸ‘€</label>
             </div>
        </div>

        <hr>

        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="pills-create-tab" data-bs-toggle="pill" data-bs-target="#pills-create" type="button">Create New Room</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pills-join-tab" data-bs-toggle="pill" data-bs-target="#pills-join" type="button">Join Existing</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-create">
                <button class="btn btn-success w-100" onclick="createRoom()">ðŸš€ Start New Session</button>
            </div>
            
            <div class="tab-pane fade" id="pills-join">
                <div class="input-group">
                    <input type="text" id="roomIdInput" class="form-control" placeholder="Paste Room ID here">
                    <button class="btn btn-primary" onclick="joinRoom()">Join</button>
                </div>
            </div>
        </div>
        
        <div id="loginError" class="text-danger mt-2 text-center" style="display:none;"></div>
    </div>
</div>

<div class="container py-5" id="mainApp" style="filter: blur(5px);">
    
    <div class="position-absolute top-0 end-0 p-3">
        <div class="position-absolute top-0 end-0 p-3 d-flex align-items-center gap-2">
            <div id="roomInfoDisplay" class="badge bg-light text-dark border room-badge p-2 shadow-sm" style="display:none; font-size: 0.9rem;" onclick="copyRoomId()" title="Click to Copy ID">
                Room ID: <span id="currentRoomDisplay" class="fw-bold font-monospace">...</span> ðŸ“‹
            </div>
            <button id="logoutBtn" class="btn btn-danger btn-sm shadow-sm" style="display:none;" onclick="logout()">
                Exit ðŸšª
            </button>
        </div>
    </div>

    <h1 class="text-center mb-4">Planning Poker</h1>

    <div class="card mb-4">
        <div class="card-header bg-dark text-white">Controls (Anyone can act as Admin)</div>
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <input type="text" id="jiraTicket" class="form-control" placeholder="JIRA Ticket (e.g. PROJ-123)">
                </div>
                <div class="col-auto">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="publicVote" checked>
                        <label class="form-check-label" for="publicVote">Public Votes</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="startVote()">Start New Vote</button>
                    <button class="btn btn-warning" onclick="revealVote()">Reveal Results</button>
                    <button class="btn btn-secondary" onclick="resetVote()">Reset</button>
                    <a href="/history" class="btn btn-outline-info ms-2">View History</a>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mb-5">
        <h2 id="currentTicketDisplay">Waiting for session...</h2>
        <div id="statusMessage" class="text-muted"></div>
    </div>

    <div id="votingInterface" class="row justify-content-center mb-5" style="display:none;">
        <div class="col-md-8 text-center">
            <h5>Cast your vote:</h5>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <div class="card p-3 card-select shadow-sm" onclick="castVote(1)">1</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(2)">2</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(3)">3</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(5)">5</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(8)">8</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(13)">13</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(21)">21</div>
            </div>
        </div>
    </div>

    <div id="observerMessage" class="text-center mb-5 alert alert-info" style="display:none;">
        <h4>ðŸ‘€ You are observing this session.</h4>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Participants</div>
                <ul class="list-group list-group-flush" id="votersList">
                    </ul>
            </div>
        </div>

        <div class="col-md-6 text-center">
            <div class="card">
                <div class="card-header">Results Distribution</div>
                <div class="card-body">
                    <div id="chartContainer">
                        <canvas id="resultsChart"></canvas>
                    </div>
                    <p id="chartPlaceholder" class="text-muted mt-5">Waiting for reveal...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const socket = io();
    let myChart = null;
    let myRole = 'voter';
    let currentRoomId = null;

    // --- Socket Listeners ---
    socket.on('connect', () => {
        console.log("Connected to server");
        
        // --- NEW: AUTO-RECONNECT LOGIC ---
        // Check if we have session data in storage
        const savedRoom = sessionStorage.getItem('poker_room');
        const savedName = sessionStorage.getItem('poker_name');
        const savedRole = sessionStorage.getItem('poker_role');

        // If data exists and we aren't already in a room (avoids double join on disconnect/reconnect)
        if (savedRoom && savedName && !currentRoomId) {
            console.log("Restoring session for room:", savedRoom);
            
            // Restore visual state for inputs (in case user logs out later)
            document.getElementById('joinName').value = savedName;
            document.getElementById('roomIdInput').value = savedRoom;
            if(savedRole === 'observer') {
                document.getElementById('roleObserver').checked = true;
            } else {
                document.getElementById('roleVoter').checked = true;
            }
            
            // Restore global role variable
            myRole = savedRole;

            // Trigger the join event
            socket.emit('join_room_request', { 
                name: savedName, 
                role: savedRole, 
                room_id: savedRoom 
            });
        }
    });

    socket.on('room_created', (data) => {
        enterApp(data.room_id);
    });

    socket.on('room_joined', (data) => {
        enterApp(data.room_id);
    });

    socket.on('error_msg', (data) => {
        showError(data.msg);
    });

    socket.on('state_update', (state) => {
        updateUI(state);
    });

    socket.on('notification', (data) => {
        console.log(data.msg);
    });

    // --- Login / Room Actions ---
    function createRoom() {
        const name = document.getElementById('joinName').value;
        if(!name) return showError("Please enter your name");
        
        myRole = document.querySelector('input[name="role"]:checked').value;
        socket.emit('create_room', { name: name, role: myRole });
    }

    function joinRoom() {
        const name = document.getElementById('joinName').value;
        const rId = document.getElementById('roomIdInput').value;
        
        if(!name) return showError("Please enter your name");
        if(!rId) return showError("Please enter a Room ID");

        myRole = document.querySelector('input[name="role"]:checked').value;
        socket.emit('join_room_request', { name: name, role: myRole, room_id: rId });
    }

    // --- Main Game Actions ---
    function startVote() {
        const ticket = document.getElementById('jiraTicket').value;
        const isPublic = document.getElementById('publicVote').checked;
        if(!ticket) return alert("Please enter a Jira Ticket ID");
        
        socket.emit('start_vote', { 
            room_id: currentRoomId, 
            ticket_key: ticket, 
            is_public: isPublic 
        });
    }

    function castVote(value) {
        socket.emit('cast_vote', { 
            room_id: currentRoomId,
            vote_value: value 
        });
        document.getElementById('statusMessage').innerText = `You selected: ${value}`;
    }

    function revealVote() {
        socket.emit('reveal_vote', { room_id: currentRoomId });
    }

    function resetVote() {
        socket.emit('reset', { room_id: currentRoomId });
        document.getElementById('jiraTicket').value = '';
        document.getElementById('statusMessage').innerText = '';
    }

    // --- UI Helpers ---
    function enterApp(roomId) {
        currentRoomId = roomId;
        
        // --- NEW: SAVE STATE TO STORAGE ---
        // Save these details so we can survive a page refresh
        const name = document.getElementById('joinName').value;
        // Role might be in DOM or in myRole variable depending on flow, let's grab from DOM to be safe
        // or rely on what we set in createRoom/joinRoom
        const role = document.querySelector('input[name="role"]:checked').value;
        
        sessionStorage.setItem('poker_room', roomId);
        sessionStorage.setItem('poker_name', name);
        sessionStorage.setItem('poker_role', role);
        // ----------------------------------

        document.getElementById('joinScreen').style.display = 'none';
        document.getElementById('mainApp').style.filter = 'none';
        
        // Show Room ID
        document.getElementById('roomInfoDisplay').style.display = 'block';
        document.getElementById('currentRoomDisplay').innerText = roomId;
        document.getElementById('logoutBtn').style.display = 'block';
    }

    function showError(msg) {
        const el = document.getElementById('loginError');
        el.innerText = msg;
        el.style.display = 'block';
    }

    function copyRoomId() {
        navigator.clipboard.writeText(currentRoomId);
        alert("Room ID copied to clipboard!");
    }

    // --- Main UI Update Logic ---
    function updateUI(state) {
        // 1. Header Info
        document.getElementById('currentTicketDisplay').innerText = 
            state.active ? `Voting on: ${state.ticket_key}` : "Waiting for session...";
        
        // 2. Voting Interface Visibility
        const votingInterface = document.getElementById('votingInterface');
        const observerMessage = document.getElementById('observerMessage');

        if (state.active && !state.revealed) {
            if (myRole === 'voter') {
                votingInterface.style.display = 'flex';
                observerMessage.style.display = 'none';
            } else {
                votingInterface.style.display = 'none';
                observerMessage.style.display = 'block';
            }
        } else {
            votingInterface.style.display = 'none';
            observerMessage.style.display = 'none';
        }

        // 3. Admin Buttons (Security Check)
        const revealBtn = document.querySelector('button[onclick="revealVote()"]');
        const resetBtn = document.querySelector('button[onclick="resetVote()"]');
        const amIAdmin = (socket.id === state.admin_sid);
        
        if (state.active) {
            revealBtn.disabled = !amIAdmin;
            resetBtn.disabled = !amIAdmin;
            if(!amIAdmin) {
                revealBtn.title = "Only the starter can reveal";
                resetBtn.title = "Only the starter can reset";
            } else {
                revealBtn.title = "";
                resetBtn.title = "";
            }
        } else {
            revealBtn.disabled = true; 
            resetBtn.disabled = false; 
        }

        // 4. Participants List
        const list = document.getElementById('votersList');
        list.innerHTML = '';
        const participants = state.participants || [];
        
        participants.forEach(p => {
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            
            let badgeClass = 'bg-secondary';
            let badgeContent = p.display_value || 'Waiting';

            if (p.role === 'observer') {
                badgeClass = 'bg-info text-dark';
                badgeContent = 'ðŸ‘€'; 
            } else if (p.display_value === 'âœ…') {
                badgeClass = 'bg-success'; 
            } else if (!isNaN(p.display_value)) {
                badgeClass = 'bg-primary'; 
            }

            li.innerHTML = `
                <span>
                    ${p.name} 
                    ${p.role === 'observer' ? '<small class="text-muted ms-1">(Observer)</small>' : ''}
                </span>
                <span class="badge ${badgeClass} rounded-pill">
                    ${badgeContent}
                </span>
            `;
            list.appendChild(li);
        });

        // 5. Chart Logic
        const chartContainer = document.getElementById('chartContainer');
        const placeholder = document.getElementById('chartPlaceholder');
        
        if (state.revealed && Object.keys(state.distribution).length > 0) {
            placeholder.style.display = 'none';
            renderChart(state.distribution);
        } else {
            if(myChart) myChart.destroy();
            placeholder.style.display = 'block';
        }
    }

    function renderChart(distribution) {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        const labels = Object.keys(distribution).map(k => `Vote ${k}`);
        const data = Object.values(distribution);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votes',
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            }
        });
    }
 
    function logout() {
    // Clear the saved session details
    sessionStorage.removeItem('poker_room');
    sessionStorage.removeItem('poker_name');
    sessionStorage.removeItem('poker_role');
    
    // Reload page to return to the Login/Join screen
    window.location.reload();
}
</script>
</body>
</html>