<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jira Poker Planning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .card-select { cursor: pointer; transition: 0.2s; }
        .card-select:hover { transform: scale(1.1); background-color: #0d6efd; color: white; }
        .voted-badge { background-color: #198754; color: white; }
        .waiting-badge { background-color: #ffc107; color: black; }
        #chartContainer { max-width: 400px; margin: 0 auto; }
    </style>
</head>
<body>

<div class="container py-5">
    <h1 class="text-center mb-4">Planning Poker</h1>

    <div class="row mb-4 justify-content-center">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">My Name</span>
                <input type="text" id="username" class="form-control" placeholder="Enter your name">
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-dark text-white">Controls (Anyone can act as Admin)</div>
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <input type="text" id="jiraTicket" class="form-control" placeholder="JIRA Ticket (e.g. PROJ-123)">
                </div>
                <div class="col-auto">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="publicVote" checked>
                        <label class="form-check-label" for="publicVote">Public Votes</label>
                    </div>
                </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" onclick="startVote()">Start New Vote</button>
                        <button class="btn btn-warning" onclick="revealVote()">Reveal Results</button>
                        <button class="btn btn-secondary" onclick="resetVote()">Reset</button>
                        
                        <a href="/history" class="btn btn-outline-info ms-2">View History</a>
                    </div>
            </div>
        </div>
    </div>

    <div class="text-center mb-5">
        <h2 id="currentTicketDisplay">Waiting for session...</h2>
        <div id="statusMessage" class="text-muted"></div>
    </div>

    <div id="votingSection" class="row justify-content-center mb-5" style="display:none;">
        <div class="col-md-8 text-center">
            <h5>Cast your vote:</h5>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <div class="card p-3 card-select shadow-sm" onclick="castVote(1)">1</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(2)">2</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(3)">3</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(5)">5</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(8)">8</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(13)">13</div>
                <div class="card p-3 card-select shadow-sm" onclick="castVote(21)">21</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Voters</div>
                <ul class="list-group list-group-flush" id="votersList">
                    </ul>
            </div>
        </div>

        <div class="col-md-6 text-center">
            <div class="card">
                <div class="card-header">Results Distribution</div>
                <div class="card-body">
                    <div id="chartContainer">
                        <canvas id="resultsChart"></canvas>
                    </div>
                    <p id="chartPlaceholder" class="text-muted mt-5">Waiting for reveal...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myChart = null;

    // --- Socket Listeners ---
    socket.on('connect', () => {
        console.log("Connected to server");
    });

    socket.on('state_update', (state) => {
        updateUI(state);
    });

    socket.on('notification', (data) => {
        // Optional: Add toast notifications here
        console.log(data.msg);
    });

    // --- Actions ---
    function startVote() {
        const ticket = document.getElementById('jiraTicket').value;
        const isPublic = document.getElementById('publicVote').checked;
        if(!ticket) return alert("Please enter a Jira Ticket ID");
        
        socket.emit('start_vote', { ticket_key: ticket, is_public: isPublic });
    }

    function castVote(value) {
        const username = document.getElementById('username').value;
        if(!username) return alert("Please enter your name first!");
        
        socket.emit('cast_vote', { user_name: username, vote_value: value });
        // Visual feedback
        document.getElementById('statusMessage').innerText = `You voted: ${value}`;
    }

    function revealVote() {
        socket.emit('reveal_vote');
    }

    function resetVote() {
        socket.emit('reset');
        document.getElementById('jiraTicket').value = '';
    }

// --- UI Update Logic ---
    function updateUI(state) {
        // 1. Header Info
        document.getElementById('currentTicketDisplay').innerText = 
            state.active ? `Voting on: ${state.ticket_key}` : "Waiting for session...";
        
        // 2. Voting Section Visibility
        const votingSection = document.getElementById('votingSection');
        // logic remains the same...
        if (state.active && !state.revealed) {
            votingSection.style.display = 'flex';
        } else {
            votingSection.style.display = 'none';
        }

        // --- NEW: Admin Button Logic ---
        const revealBtn = document.querySelector('button[onclick="revealVote()"]');
        const resetBtn = document.querySelector('button[onclick="resetVote()"]');
        
        // Check if I am the admin
        const amIAdmin = (socket.id === state.admin_sid);
        
        // If a vote is active, only Admin can touch these. 
        // If inactive, anyone can start (and thus reset/setup).
        if (state.active) {
            revealBtn.disabled = !amIAdmin;
            resetBtn.disabled = !amIAdmin;
            
            // Optional: Visual cue
            if(!amIAdmin) {
                revealBtn.title = "Only the starter can reveal";
                resetBtn.title = "Only the starter can reset";
            } else {
                revealBtn.title = "";
                resetBtn.title = "";
            }
        } else {
            // When inactive, buttons are enabled (or generally reset doesn't matter)
            revealBtn.disabled = true; // Can't reveal nothing
            resetBtn.disabled = false; // Anyone can clean up
        }

        // 3. Voters List (remains the same) ...
        const list = document.getElementById('votersList');
        list.innerHTML = '';
        state.votes.forEach(vote => {
            // ... (existing list logic) ...
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            let valDisplay = vote.value;
            li.innerHTML = `
                ${vote.name}
                <span class="badge ${valDisplay === '?' ? 'bg-secondary' : 'bg-success'} rounded-pill">
                    ${valDisplay}
                </span>
            `;
            list.appendChild(li);
        });

        // 4. Chart Logic (remains the same) ...
        const chartContainer = document.getElementById('chartContainer');
        const placeholder = document.getElementById('chartPlaceholder');
        
        if (state.revealed && Object.keys(state.distribution).length > 0) {
            placeholder.style.display = 'none';
            renderChart(state.distribution);
        } else {
            if(myChart) myChart.destroy();
            placeholder.style.display = 'block';
        }
    }

        // 4. Chart Logic
        const chartContainer = document.getElementById('chartContainer');
        const placeholder = document.getElementById('chartPlaceholder');
        
        if (state.revealed && Object.keys(state.distribution).length > 0) {
            placeholder.style.display = 'none';
            renderChart(state.distribution);
        } else {
            if(myChart) myChart.destroy();
            placeholder.style.display = 'block';
        }
    }

    function renderChart(distribution) {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        const labels = Object.keys(distribution).map(k => `Vote ${k}`);
        const data = Object.values(distribution);

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votes',
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            }
        });
    }
</script>
</body>
</html>
